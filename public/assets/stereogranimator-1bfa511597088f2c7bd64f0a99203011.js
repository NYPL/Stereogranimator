function init(){$("#yescanvas").show(),$("#nocanvas").hide(),toggleInstructions(),canvas=document.getElementById("testCanvas"),processcanvas=document.getElementById("processCanvas"),resultcanvas=document.getElementById("resultCanvas"),document.getElementById("btnNext").onclick=generate,$("#btnNext").hide(),document.getElementById("toggleGIF").onclick=function(){toggleMode("GIF")},document.getElementById("toggleAna").onclick=function(){toggleMode("ANAGLYPH")},document.getElementById("slowSpeed").onclick=function(){changeSpeed(SLOWSPEED)},document.getElementById("medSpeed").onclick=function(){changeSpeed(MEDSPEED)},document.getElementById("fastSpeed").onclick=function(){changeSpeed(FASTSPEED)},canvas.ontouchend=function(){isdown=!1,sq1.over=sq2.over=vert_sprite.over=!1},canvas.ontouchstart=function(){previewActive=!0},stage=new Stage(canvas),stage.enableMouseOver(10),Touch.enable(stage),changeSpeed(speed),toggleMode(mode),loadPhoto(index),Ticker.setInterval(10)}function centerPhoto(){OFFSET=Math.floor((canvas.width-img.width)*.5),bmp.x=OFFSET,bmp.y=0}function run(){lasttick=(new Date).getTime(),bmp=new Bitmap(img),stage.addChild(bmp),centerPhoto(),bg=new Shape,stage.addChild(bg),sq1x=bmp.x+Math.round(img.width*.5)-hsize-INSET,sq1y=bmp.y+Math.round(img.height*.5)-vsize*.5,sq2x=bmp.x+Math.round(img.width*.5)+INSET,sq2y=bmp.y+Math.round(img.height*.5)-vsize*.5,vertx=bmp.x+img.width*.5,verty=bmp.y+img.height*.5,sq1=new Shape,sq1.over=!1,sq1.mx=0,sq1.my=0,stage.addChild(sq1),sq2=new Shape,sq2.over=!1,sq2.mx=0,sq2.my=0,stage.addChild(sq2),txt=new Text("drag me","20px "+thefont,"#fff"),txt.textBaseline="middle",txt.lineWidth=80,txt.x=0,txt.y=-100,stage.addChild(txt),vtxt=new Text("<- shift axis   shift axis ->","20px "+thefont,"#fff"),vtxt.textBaseline="middle",vtxt.lineWidth=216,vtxt.x=-1e3,vtxt.y=445,stage.addChild(vtxt),vert_sprite=new Shape,vert_sprite.over=!1,vert_sprite.x=vertx,vert_sprite.y=verty,stage.addChild(vert_sprite);var a,b;corner_sprites=[];for(a=0;a<8;++a)b=new Shape,b.mysquare=a<4?sq1:sq2,b.mode=a<4?"left":"right",a%4==0?(b.xfactor=0,b.yfactor=0):a%4==1?(b.xfactor=1,b.yfactor=0):a%4==2?(b.xfactor=0,b.yfactor=1):a%4==3&&(b.xfactor=1,b.yfactor=1),stage.addChild(b),corner_sprites[a]=b;grid=new Shape,stage.addChild(grid),rotateLeftBtn=new Shape,rotateLeftBtn.over=!1,rotateLeftBtn.x=10,rotateLeftBtn.y=stageHeight-20-rotateSize,stage.addChild(rotateLeftBtn),rotateRightBtn=new Shape,rotateRightBtn.over=!1,rotateRightBtn.x=30+rotateSize,rotateRightBtn.y=stageHeight-20-rotateSize,stage.addChild(rotateRightBtn),rotateText=new Text("rotate image left/right","20px "+thefont,"#fff"),rotateText.textBaseline="middle",rotateText.lineWidth=216,rotateText.x=10+rotateSize+rotateSize+30,rotateText.y=stageHeight-20-rotateSize*.5,stage.addChild(rotateText),modeText=new Text("","20px "+thefont,"#fff"),modeText.textBaseline="middle",modeText.lineWidth=100,modeText.x=10,modeText.y=stageHeight-20-rotateSize*.5,stage.addChild(modeText),modeBtn=new Shape,modeBtn.over=!1,modeBtn.x=10,modeBtn.y=stageHeight-20-rotateSize,stage.addChild(modeBtn),Ticker.addListener(window)}function addInteractivity(){(function(a){modeBtn.onPress=function(a){update=!0,drawMode=="normal"?drawMode="rotate":(drawMode="normal",getImageFromServer(xid))},modeBtn.onMouseOver=function(){modeText.color="#f00",a.over=!0,update=!0},modeBtn.onMouseOut=function(){modeText.color="#fff",a.over=!1,update=!0}})(modeBtn),function(a){rotateLeftBtn.onPress=function(a){imageRotation>-maxRotation&&(imageRotation-=rotationIncrement,rotateImage(),previewActive=!0,update=!0)},rotateLeftBtn.onMouseOver=function(){a.over=!0,update=!0},rotateLeftBtn.onMouseOut=function(){a.over=!1,update=!0}}(rotateLeftBtn),function(a){rotateRightBtn.onPress=function(a){imageRotation<maxRotation&&(imageRotation+=rotationIncrement,rotateImage(),previewActive=!0,update=!0)},rotateRightBtn.onMouseOver=function(){a.over=!0,update=!0},rotateRightBtn.onMouseOut=function(){a.over=!1,update=!0}}(rotateRightBtn),function(a){vert_sprite.onPress=function(b){previewActive||(previewActive=!0,update=!0),vert_sprite.mx=vertx-stage.mouseX,vert_sprite.sq1x=vertx-sq1x,vert_sprite.sq2x=vertx-sq2x,b.onMouseMove=function(b){vertx=stage.mouseX+a.mx,sq1x=vertx-a.sq1x,sq2x=vertx-a.sq2x,update=!0}},vert_sprite.onMouseOver=function(){a.over=!0,update=!0},vert_sprite.onMouseOut=function(){a.over=!1,update=!0}}(vert_sprite),function(a){sq1.onPress=function(b){previewActive||(previewActive=!0,update=!0),sq1.mx=sq1x-stage.mouseX,sq1.my=sq1y-stage.mouseY;var c=vertx-sq1x;b.onMouseMove=function(b){sq1x=stage.mouseX+a.mx,stage.mouseX+a.mx+hsize>vertx&&(sq1x=vertx-hsize),sq1x<0&&(sq1x=0),sq1y=stage.mouseY+a.my,sq1y<0&&(sq1y=0),sq1y+vsize>stageHeight&&(sq1y=stageHeight-vsize),c=vertx-sq1x,sq2x=vertx+c-hsize,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},sq1.onMouseOver=function(){a.over=!0,update=!0},sq1.onMouseOut=function(){a.over=!1,update=!0}}(sq1),function(a){sq2.onPress=function(b){previewActive||(previewActive=!0,update=!0),sq2.mx=sq2x-stage.mouseX,sq2.my=sq2y-stage.mouseY;var c=vertx-sq2x;b.onMouseMove=function(b){sq2x=stage.mouseX+a.mx,stage.mouseX+a.mx<vertx&&(sq2x=vertx),sq2x+hsize>stageWidth&&(sq2x=stageWidth-hsize),sq2y=stage.mouseY+a.my,sq2y<0&&(sq2y=0),sq2y+vsize>stageHeight&&(sq2y=stageHeight-vsize),c=vertx-sq2x,sq1x=vertx+c-hsize,sq1y=sq2y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},sq2.onMouseOver=function(){a.over=!0,update=!0},sq2.onMouseOut=function(){a.over=!1,update=!0}}(sq2),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="right"&&a.x-CORNER_OFFSET<vertx&&(a.x=vertx+CORNER_OFFSET+1),a.x>a.x2-MINSIZE&&(a.x=a.x2-MINSIZE),hsize=a.x2-(a.x-CORNER_OFFSET),hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y>a.y2-MINSIZE&&(a.y=a.y2-MINSIZE),vsize=a.y2-(a.y-CORNER_OFFSET),vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x-CORNER_OFFSET,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x-CORNER_OFFSET,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y-CORNER_OFFSET,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[0]),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="left"&&a.x+CORNER_OFFSET>vertx&&(a.x=vertx-CORNER_OFFSET-1),a.x<a.x1+MINSIZE&&(a.x=a.x1+MINSIZE),hsize=a.x+CORNER_OFFSET-a.x1,hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y>a.y2-MINSIZE&&(a.y=a.y2-MINSIZE),vsize=a.y2-(a.y-CORNER_OFFSET),vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x+CORNER_OFFSET-hsize,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x+CORNER_OFFSET-hsize,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y-CORNER_OFFSET,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[1]),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="right"&&a.x-CORNER_OFFSET<=vertx&&(a.x=vertx+CORNER_OFFSET+1),a.x>a.x2-MINSIZE&&(a.x=a.x2-MINSIZE),hsize=a.x2-(a.x-CORNER_OFFSET),hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y<a.y1+MINSIZE&&(a.y=a.y1+MINSIZE),vsize=a.y+CORNER_OFFSET-a.y1,vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x-CORNER_OFFSET,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x-CORNER_OFFSET,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y+CORNER_OFFSET-vsize,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[2]),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="left"&&a.x+CORNER_OFFSET>vertx&&(a.x=vertx-CORNER_OFFSET-1),a.x<a.x1+MINSIZE&&(a.x=a.x1+MINSIZE),hsize=a.x+CORNER_OFFSET-a.x1,hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y<a.y1+MINSIZE&&(a.y=a.y1+MINSIZE),vsize=a.y+CORNER_OFFSET-a.y1,vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x+CORNER_OFFSET-hsize,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x+CORNER_OFFSET-hsize,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y+CORNER_OFFSET-vsize,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[3]),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="right"&&a.x-CORNER_OFFSET<vertx&&(a.x=vertx+CORNER_OFFSET+1),a.x>a.x2-MINSIZE&&(a.x=a.x2-MINSIZE),hsize=a.x2-(a.x-CORNER_OFFSET),hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y>a.y2-MINSIZE&&(a.y=a.y2-MINSIZE),vsize=a.y2-(a.y-CORNER_OFFSET),vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x-CORNER_OFFSET,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x-CORNER_OFFSET,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y-CORNER_OFFSET,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[4]),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="left"&&a.x+CORNER_OFFSET>vertx&&(a.x=vertx-CORNER_OFFSET-1),a.x<a.x1+MINSIZE&&(a.x=a.x1+MINSIZE),hsize=a.x+CORNER_OFFSET-a.x1,hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y>a.y2-MINSIZE&&(a.y=a.y2-MINSIZE),vsize=a.y2-(a.y-CORNER_OFFSET),vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x+CORNER_OFFSET-hsize,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x+CORNER_OFFSET-hsize,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y-CORNER_OFFSET,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[5]),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="right"&&a.x-CORNER_OFFSET<=vertx&&(a.x=vertx+CORNER_OFFSET+1),a.x>a.x2-MINSIZE&&(a.x=a.x2-MINSIZE),hsize=a.x2-(a.x-CORNER_OFFSET),hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y<a.y1+MINSIZE&&(a.y=a.y1+MINSIZE),vsize=a.y+CORNER_OFFSET-a.y1,vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x-CORNER_OFFSET,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x-CORNER_OFFSET,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y+CORNER_OFFSET-vsize,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[6]),function(a){a.onPress=function(b){previewActive||(previewActive=!0,update=!0),a.mx=stage.mouseX-a.x,a.my=stage.mouseY-a.y,a.sh=hsize,a.sv=vsize,a.x1=a.mysquare==sq1?sq1x:sq2x,a.y1=a.mysquare==sq1?sq1y:sq2y,a.x2=a.x1+hsize,a.y2=a.y1+vsize,b.onMouseMove=function(b){a.x=stage.mouseX-a.mx,a.mode=="left"&&a.x+CORNER_OFFSET>vertx&&(a.x=vertx-CORNER_OFFSET-1),a.x<a.x1+MINSIZE&&(a.x=a.x1+MINSIZE),hsize=a.x+CORNER_OFFSET-a.x1,hsize<MINSIZE&&(hsize=MINSIZE),a.y=stage.mouseY-a.my,a.y<a.y1+MINSIZE&&(a.y=a.y1+MINSIZE),vsize=a.y+CORNER_OFFSET-a.y1,vsize<MINSIZE&&(vsize=MINSIZE),a.mode=="left"?(sq1x=a.x+CORNER_OFFSET-hsize,sq2x=vertx+vertx-sq1x-hsize):(sq2x=a.x+CORNER_OFFSET-hsize,sq1x=vertx-(sq2x-vertx)-hsize),sq1y=a.y+CORNER_OFFSET-vsize,sq2y=sq1y,update=!0},isdown=!0,b.onMouseUp=function(a){isdown=!1}},a.onMouseOver=function(){a.over=!0,update=!0},a.onMouseOut=function(){a.over=!1,update=!0}}(corner_sprites[7])}function draw(){drawMode=="normal"?(clearGrid(),drawBackground(),drawVertical(),drawSquare(sq1,sq1x,sq1y),drawSquare(sq2,sq2x,sq2y),drawCorners(),drawText()):(clearBackground(),clearVertical(),clearSquares(),clearCorners(),drawGrid()),drawRotate()}function clearGrid(){grid.graphics.clear()}function drawGrid(){var a=grid.graphics,b,c=17,d=14,e=img.width/c,f=img.height/d,g=img.height,h=img.width;a.clear(),a.setStrokeStyle(1,"round","round"),a.beginStroke(COLOR);for(b=1;b<c;++b)a.moveTo(b*e,0).lineTo(b*e,stageHeight-60);for(b=1;b<d;++b)a.moveTo(0,b*f).lineTo(stageWidth,b*f)}function rotateImage(){bmp.rotation=imageRotation;var a=imageRotation*(Math.PI/180),b=Math.sin(a)*img.height,c=Math.sin(a)*img.width;imageRotation>0&&(bmp.x=b+OFFSET),imageRotation<0&&(bmp.y=-c)}function drawRotate(){var a;drawMode=="rotate"?(rotateText.visible=!0,a=rotateLeftBtn.graphics,a.clear(),a.setStrokeStyle(THICK,"round","round"),rotateLeftBtn.over?a.beginStroke(OVERCOLOR):a.beginStroke(COLOR),a.beginFill(FILLALPHA),a.drawRect(0,0,rotateSize,rotateSize),a.moveTo(20,25).lineTo(20,10).lineTo(5,10).lineTo(10,5).moveTo(5,10).lineTo(10,15),a=rotateRightBtn.graphics,a.clear(),a.setStrokeStyle(THICK,"round","round"),rotateRightBtn.over?a.beginStroke(OVERCOLOR):a.beginStroke(COLOR),a.beginFill(FILLALPHA),a.drawRect(0,0,rotateSize,rotateSize),a.moveTo(10,25).lineTo(10,10).lineTo(25,10).lineTo(20,5).moveTo(25,10).lineTo(20,15),modeText.text="edit mode",modeText.x=325,modeBtn.x=320,a=modeBtn.graphics,a.clear(),a.setStrokeStyle(THICK,"round","round"),modeBtn.over?a.beginStroke(OVERCOLOR):a.beginStroke(COLOR),a.beginFill(FILLALPHA),a.drawRect(0,0,90,rotateSize)):(rotateText.visible=!1,a=rotateLeftBtn.graphics,a.clear(),a=rotateRightBtn.graphics,a.clear(),modeText.text="rotate mode",modeText.x=15,modeBtn.x=10,a=modeBtn.graphics,a.clear(),a.setStrokeStyle(THICK,"round","round"),modeBtn.over?a.beginStroke(OVERCOLOR):a.beginStroke(COLOR),a.beginFill(FILLALPHA),a.drawRect(0,0,110,rotateSize))}function drawText(){sq1.over?(txt.x=sq1x+hsize*.5-txt.lineWidth,txt.y=sq1y+vsize*.5+INSET):sq2.over?(txt.x=sq2x+hsize*.5+INSET,txt.y=sq2y+vsize*.5+INSET):(txt.x=-1e3,txt.y=-1e3),vert_sprite.over?(vtxt.x=vertx-vtxt.lineWidth*.5,vtxt.y=sq1y+vsize+30,vtxt.y>stageHeight-30&&(vtxt.y=sq1y+vsize-30)):vtxt.x=-1e3}function clearBackground(){bg.graphics.clear()}function drawBackground(){var a=bg.graphics;a.clear(),a.beginStroke(null),a.beginFill(BACKALPHA),a.drawRect(0,0,stageWidth,sq1y),a.drawRect(0,sq1y,sq1x,vsize),a.drawRect(sq2x+hsize,sq1y,stageWidth-(sq2x+hsize),vsize),a.drawRect(0,sq1y+vsize,stageWidth,stageHeight-vsize-sq1y)}function clearVertical(){vert_sprite.graphics.clear()}function drawVertical(){vert_sprite.x=vertx;var a=vert_sprite.graphics;a.clear(),a.setStrokeStyle(THICK,"round","round"),vert_sprite.over?vert_sprite.graphics.beginStroke(OVERCOLOR):vert_sprite.graphics.beginStroke(COLOR),a.beginFill(FILLALPHA),a.drawRect(-(VERTWIDTH*.5),-(VERTHEIGHT*.5),VERTWIDTH,VERTHEIGHT),a.moveTo(0,-(VERTHEIGHT*.5)).lineTo(0,-stageHeight).moveTo(0,VERTHEIGHT*.5).lineTo(0,stageHeight),a.moveTo(-(VERTWIDTH*.5),0).lineTo(-(VERTWIDTH*.5),VERTWIDTH*.5).lineTo(-VERTWIDTH,0).lineTo(-(VERTWIDTH*.5),-(VERTWIDTH*.5)).lineTo(-(VERTWIDTH*.5),0),a.moveTo(VERTWIDTH*.5,0).lineTo(VERTWIDTH*.5,VERTWIDTH*.5).lineTo(VERTWIDTH,0).lineTo(VERTWIDTH*.5,-(VERTWIDTH*.5)).lineTo(VERTWIDTH*.5,0)}function clearCorners(){var a;for(a=0;a<8;++a)corner_sprites[a].graphics.clear()}function drawCorners(){var a=-1e3,b=-1e3,c,d;for(c=0;c<8;++c)d=corner_sprites[c],d.graphics.clear(),d.over?d.graphics.beginStroke(OVERCOLOR):d.graphics.beginStroke(COLOR),d.graphics.beginFill(FILLALPHA),d.graphics.setStrokeStyle(THICK,"round","round"),d.graphics.drawRect(-CORNER_OFFSET,-CORNER_OFFSET,CORNER_OFFSET+CORNER_OFFSET,CORNER_OFFSET+CORNER_OFFSET),d.mysquare==sq1?(a=sq1x,b=sq1y):d.mysquare==sq2&&(a=sq2x,b=sq2y),d.x=a+CORNER_OFFSET+(hsize-CORNER_OFFSET-CORNER_OFFSET)*d.xfactor,d.y=b+CORNER_OFFSET+(vsize-CORNER_OFFSET-CORNER_OFFSET)*d.yfactor}function clearSquares(){sq1.graphics.clear(),sq2.graphics.clear()}function drawSquare(a,b,c){var d=a.graphics,e=INSET;d.clear(),d.setStrokeStyle(THICK,"round","round"),a.over?d.beginStroke(OVERCOLOR):d.beginStroke(COLOR),d.beginFill(FILLALPHA),d.drawRect(b,c,hsize,vsize),e=INSET*2,d.moveTo(b-e+hsize*.5,c+vsize*.5).lineTo(b+e+hsize*.5,c+vsize*.5).moveTo(b+hsize*.5,c-e+vsize*.5).lineTo(b+hsize*.5,c+e+vsize*.5),d.moveTo(b-e+hsize*.5+e*.3,c+vsize*.5+e*.3).lineTo(b-e+hsize*.5,c+vsize*.5).lineTo(b-e+hsize*.5+e*.3,c-e*.3+vsize*.5),d.moveTo(b+e+hsize*.5-e*.3,c+vsize*.5-e*.3).lineTo(b+e+hsize*.5,c+vsize*.5).lineTo(b+e+hsize*.5-e*.3,c+e*.3+vsize*.5),d.moveTo(b-e*.3+hsize*.5,c-e+vsize*.5+e*.3).lineTo(b+hsize*.5,c-e+vsize*.5).lineTo(b+e*.3+hsize*.5,c-e+vsize*.5+e*.3),d.moveTo(b-e*.3+hsize*.5,c+e+vsize*.5-e*.3).lineTo(b+hsize*.5,c+e+vsize*.5).lineTo(b+e*.3+hsize*.5,c+e+vsize*.5-e*.3)}function tick(){previewActive&&drawMode=="normal"&&($("#previewExplain").hide(),$("#btnNext").fadeIn()),update&&(draw(),update=!1,updatePreview(),stage.update(),previewActive&&mode=="ANAGLYPH"&&drawMode=="normal"&&drawAnaglyph()),previewActive&&mode=="GIF"&&drawMode=="normal"&&drawGIF(),drawMode=="rotate"&&(document.getElementById("previewGIF").style.display="none",document.getElementById("previewAnaglyph").style.display="none",$("#previewExplain").show(),$("#btnNext").hide(),$("#previewExplain").text("Preview will be created once you exit rotate mode"))}function updatePreview(){var a=document.getElementById("previewGIF");a.style.width=hsize+"px",a.style.height=vsize+"px"}function toggleMode(a){mode=a;var b=$("#toggler"),c=$("#toggleGIF"),d=$("#toggleAna"),e=$("#toggleLinks"),f=$("#GIFExtraLinks");a=="GIF"?(b.removeClass("anaglyphActive"),b.addClass("GIFActive"),d.removeClass("active"),c.addClass("active"),f.show()):(update=!0,b.addClass("anaglyphActive"),b.removeClass("GIFActive"),c.removeClass("active"),d.addClass("active"),f.hide())}function drawGIF(){document.getElementById("previewGIF").style.display="block",document.getElementById("previewAnaglyph").style.display="none",now=(new Date).getTime();if(now-lasttick>=speed){lasttick=now;var a=document.getElementById("previewGIF");frame==1?(a.style.backgroundPosition=-1*sq1x+OFFSET+"px "+ -1*sq1y+"px",frame=2):(a.style.backgroundPosition=-1*sq2x+OFFSET+"px "+ -1*sq2y+"px",frame=1)}}function drawAnaglyph(){document.getElementById("previewGIF").style.display="none",document.getElementById("previewAnaglyph").style.display="block",now=(new Date).getTime(),rightimgdata=ctxbase.getImageData(sq1x-OFFSET,sq1y,hsize,vsize),rightimgdata_array=rightimgdata.data,leftimgdata=ctxbase.getImageData(sq2x-OFFSET,sq2y,hsize,vsize),leftimgdata_array=leftimgdata.data,resultcanvas.width=hsize,resultcanvas.height=vsize;var a,b=rightimgdata_array.length,c,d,e;for(a=0;a<b;a+=4)lR=leftimgdata_array[a],lG=leftimgdata_array[a+1],lB=leftimgdata_array[a+2],lR=255,lG=255-(255-leftimgdata_array[a+1]),lB=255-(255-leftimgdata_array[a+2]),rightimgdata_array[a]=rightimgdata_array[a],rightimgdata_array[a+1]=lG,rightimgdata_array[a+2]=lB;ctx3D.putImageData(rightimgdata,0,0)}function loadPhoto(a){index=a,img.onload=handleImageLoad,img.onerror=handleImageError,imgurl="http://images.nypl.org/index.php?id="+index+"&t=w",xid!=0?$.ajax({url:"/s/v",dataType:"json",data:{id:index},success:function(a){a!=0?(imgurl=a,img=new Image,img.src="/getimagedata.jpeg?r="+imageRotation+"&url="+escape(imgurl),getImageFromServer()):alert("Image not in allowed list. Sorry :(")},statusCode:{404:function(){alert("Not found error (404)")},429:function(){alert("Too many requests (429)")},500:function(){alert("Internal server error (500)")}}}):(img=new Image,img.src=imgurl,getImageFromServer())}function getImageFromServer(){var a="/getimagedata.jpeg?r="+imageRotation+"&url="+escape(imgurl),b=document.getElementById("previewGIF");b.style.background="url('"+a+"') no-repeat -10000px -10000px",$.getImageData({url:imgurl,server:"/getimagedata/?r="+imageRotation+"&callback=?",success:function(a){ctx3D=resultcanvas.getContext("2d"),ctxbase=processcanvas.getContext("2d"),ctxbase.drawImage(a,0,0,a.width,a.height),handleImageLoad(a)},error:function(a,b){alert("error loading image")}})}function changeSpeed(a){speed=a;var b=$("#slowSpeed"),c=$("#medSpeed"),d=$("#fastSpeed");b.removeClass("active"),c.removeClass("active"),d.removeClass("active"),a==SLOWSPEED?b.toggleClass("active"):a==MEDSPEED?c.toggleClass("active"):d.toggleClass("active")}function generate(){previewActive&&(document.getElementById("btnNext").disabled=!0,document.getElementById("btnNext").onclick={},$("#btnNext").replaceWith('<div class="generator">GENERATING...</div>'),_gaq.push(["_trackEvent","Granimations",mode,"HTML"]),$.ajax({url:"/animations/createJson.json",dataType:"json",data:{x1:Math.round(sq1x-OFFSET),y1:Math.round(sq1y),x2:Math.round(sq2x-OFFSET),y2:Math.round(sq2y),height:Math.round(vsize),width:Math.round(hsize),delay:Math.round(speed),digitalid:index,rotation:imageRotation,mode:mode,xid:xid,creator:"mga"},success:function(a){is_publiceye?window.location.href="/share_pe/"+a.redirect:window.location.href="/share/"+a.redirect},statusCode:{404:function(){alert("Photo not found error (404)")},429:function(){alert("Too many requests (429)")},500:function(){alert("Internal server error (500)")}}}))}function generateFromFlash(a,b,c,d,e,f,g,h,i){_gaq.push(["_trackEvent","Granimations",i,"FLASH"]),$.ajax({url:"/animations/createJson/"+Math.round(a)+"/"+Math.round(b)+"/"+Math.round(c)+"/"+Math.round(d)+"/"+Math.round(e)+"/"+Math.round(f)+"/"+Math.round(g)+"/"+h+"/"+i+"/mga.json?xid="+xid,dataType:"json",data:null,success:function(a){is_publiceye?window.location.href="/share_pe/"+a.redirect:window.location.href="/share/"+a.redirect},statusCode:{404:function(){alert("Photo not found error (404)")},429:function(){alert("Too many requests (429)")},500:function(){alert("Internal server error (500)")}}})}function escapeHtml(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"," ":"+",".":"","'":"&#039;"};return a.replace(/[&<>"' \.]/g,function(a){return b[a]})}function searchImages(){$("#search .query").val()!=""?($("#search .status").text("Searching..."),cleaned=escapeHtml($("#search .query").val().trim()),$.ajax({url:"/choose/"+cleaned,dataType:"json",data:{xid:$(".frm-xid").val()},success:function(a){a.length>0?(image_array=a,$("#search .status").text("Found "+a.length+" result"+(a.length>1?"s":"")+"."),refreshImages()):$("#search .status").text("No results :-( Try a different keyword.")},statusCode:{404:function(){alert("Photo not found error (404)")},429:function(){alert("Too many requests (429)")},500:function(){alert("Internal server error (500)")}}})):$("#search .status").text("Please type a keyword.")}function initSearch(){$(document).keypress(function(a){a.keyCode==13&&$("#search .query").val()!=""&&searchImages()})}function initGallerySearch(){$(document).keypress(function(a){a.keyCode==13&&$("#search .query").val()!=""&&searchGallery()})}function searchGallery(){$("#search .query").val()!=""?(window.location.href="/gallery/?q="+$("#search .query").val()+"&xid="+$("#frm-collections_xid").val(),$("#search .status").text("Searching...")):$("#search .status").text("Please type a keyword.")}function refreshImages(){if(image_array.length>0){clearImages();var a=image_array.sort(function(){return Math.round(Math.random())-.5}).slice(0,9),b,c=a.length,d,e;for(b=0;b<c;++b){d=a[b].url;var f=is_publiceye?"/convert_pe/":"/convert/";e=f+a[b].id+"?xid="+a[b].xid,meta=a[b].owner,xid=a[b].xid,$("#st"+b).toggleClass("stereograph"),$("#st"+b).toggleClass("stereographPlain"),$("#link_"+b).show(),$("#linko_"+b).show(),$("#link_"+b).attr("href",e),$("#link_"+b).attr("title",meta),$("#linko_"+b).attr("href",e),$("#linko_"+b).attr("title",meta),$("#img_"+b).attr("src",d),$("#img_"+b).attr("alt",meta)}}}function clearImages(){$(".stereograph").toggleClass("stereographPlain"),$(".stereograph").toggleClass("stereograph");var a,b,c;for(a=0;a<9;++a)b="/assets/blank.png",$("#link_"+a).hide(),$("#linko_"+a).hide(),$("#img_"+a).attr("src",b)}function handleImageLoad(a){imagesLoaded++,imagesLoaded==1&&(run(),addInteractivity(),update=!0)}function handleImageError(a){}function toggleInstructions(){helpVisible?(helpVisible=!1,$(".instructions").width(1200),$(".instructions").height(540),$(".instructions").animate({width:0,height:0},500,"swing",function(){$(".showInstructions").show()})):(helpVisible=!0,$(".instructions").width(0),$(".instructions").height(0),$(".showInstructions").hide(),$(".instructions").animate({width:1200,height:540},1500,"swing"))}function disableCanvas(){$("#yescanvas").hide(),$("#nocanvas").show(),toggleInstructions()}var is_publiceye=!1,image_array=[],canvas,stage,bmp,stageWidth=800,stageHeight=550,resize_sprite,vert_sprite,corner_sprites,sheetsrc,processcanvas,resultcanvas,ctx3D,ctxbase,processimage,leftimgdata,rightimgdata,leftimgdata_array,rightimgdata_array,bg,sq1,sq2,txt,vtxt,sq1x=0,sq1y=0,sq2x=0,sq2y=0,vertx=0,verty=0,hsize=300,vsize=360,MINSIZE=80,MAXW=399,MAXH=490,SLOWSPEED=200,MEDSPEED=140,FASTSPEED=80,CORNER_POSITION=0,CORNER_TOP_LEFT=1,CORNER_TOP_RIGHT=2,CORNER_BOTTOM_LEFT=3,CORNER_BOTTOM_RIGHT=4,CORNER_OFFSET=20,VERTWIDTH=20,VERTHEIGHT=80,now=0,lasttick=0,speed=FASTSPEED,frame=1,OFFSET=0,INSET=10,THICK=2,COLOR="#ffffff",OVERCOLOR="#f00",FILL="#000",FILLALPHA="rgba(0,0,0,0.1)",BACKALPHA="rgba(0,0,0,0.75)",img=new Image,update=!0,previewActive=!1,mode="GIF",index="",ua=navigator.userAgent,isiPad=/iPad/i.test(ua)||/iPod/i.test(ua)||/iPhone/i.test(ua),isdown=!1,helpVisible=!0,rotateLeftBtn,rotateRightBtn,rotateSize=40,imageRotation=0,maxRotation=3,rotationIncrement=.1,rotateText,modeText,modeBtn,drawMode="normal",grid,imagesLoaded=0,xid=0,imgurl="",thefont="share-regular,AvenirNextCondensed-Medium,'Arial Narrow',sans-serif";